<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jroozy CMS table</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />


</head>

<body>
    <base target="_parent">
    <main>
        <table id="CMS_table">

        </table>
    </main>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope&family=Wix+Madefor+Text&display=swap');

        * {
            font-family: 'Manrope', sans-serif;
            font-family: 'Wix Madefor Text', sans-serif;
            font-weight: lighter;
        }

        body {
            margin: 0px;
            background: white !important;
        }

        #CMS_table {
            background-color: #a8caff;
        }

        .td_cont {
            max-height: 4rem;
            width: 100%;
            height: 100%;
            overflow: scroll;
            white-space: nowrap;
        }

        td,
        th {
            padding: .7rem;
            background-color: #fff;
        }

        td:hover,
        th {
            background-color: #e7f0ff;
        }

        th:hover {
            background-color: #d6e6fe;
        }

        th {
            white-space: nowrap;
        }
    </style>

    <script>
        // @ondra4sedlacek/jroozy-data-tables/ProgramLists

        let data_cache = undefined;
        let search_cache = undefined;
        let columns_blacklist = [];
        let page_num = 0;
        let page_size = 10;
        let sort_order = 0;
        let sort_column = "_id";

        let cols = [];
        let cols_name_map = {}
        let cols_type_map = {}
        let whitelisted_cols = [];

        function makeRow(items, isHeader = false) {
            let row = document.createElement("tr")

            for (let i = 0; i < items.length; i++) {
                let item = items[i];
                let item_type = cols_type_map[whitelisted_cols[i]];

                let ele_inn = document.createElement("div")
                ele_inn.classList.add("td_cont")

                if (isHeader) {
                    ele_inn.innerText = item;
                    ele_inn.innerHTML += `<i style="padding-left: 10px;" class="fa-regular fa-eye-slash" onclick='
                        window.postMessage({
                            jroozy: true,
                            action: "hide_columns",
                            columns: ["${whitelisted_cols[i]}"]
                        })
                    '></i>`
                    ele_inn.innerHTML += `<i style="padding-left: 10px;" class="fa-solid ${
                        whitelisted_cols[i] == sort_column && sort_order != 0 ? 
                        sort_order > 0 ? "fa-arrow-down" : "fa-arrow-up" : 
                        "fa-arrows-up-down"}" 
                        
                        onclick='
                        let current_order, next_order;
                        if(this.classList.contains("fa-arrows-up-down")) {
                            current_order = 0;
                            next_order = 1;
                        }
                        else if(this.classList.contains("fa-arrow-up")) {
                            current_order = -1;
                            next_order = 0;
                        }
                        else if(this.classList.contains("fa-arrow-down")) {
                            current_order = 1;
                            next_order = -1;
                        }

                        window.postMessage({
                            jroozy: true,
                            action: "sort",
                            sort_order: next_order, // 1 (ascending), 0 or -1 (descending)
                            sort_column: "${whitelisted_cols[i]}"
                        })
                    '></i>`
                } else {
                    if (item == "-" || item == "–" || item == "undefined" || item == undefined) {
                        ele_inn.innerText = "–";
                    } else {
                        switch (item_type) {
                            case "URL":
                                ele_inn.innerHTML = `<a href="${item}" target="_blank">${item}</a>`;
                                break;
                            case "Date":
                                let d = new Date(item);
                                ele_inn.innerText = d.toDateString();
                                break;
                            case "email":
                                ele_inn.innerHTML = `<a href="mailto:${item}">${item}</a>`;
                                break;
                            default:
                                ele_inn.innerText = item;
                                break;
                        }
                    }
                }

                let ele = document.createElement(isHeader ? "th" : "td")
                ele.classList.add(`col${i}`);
                ele.appendChild(ele_inn);

                row.appendChild(ele);
            }

            document.getElementById("CMS_table").appendChild(row);
        }

        function getReadableColName(colKey) {
            colKey = colKey.replaceAll(/([A-Z])/g, " $1".toUpperCase());
            colKey = colKey.replaceAll(/(\d+)/g, " $1".toUpperCase());
            return colKey.charAt(0).toUpperCase() + colKey.slice(1);
        }

        function getColType(itemVal) {
            if (typeof itemVal == "number") return "number";
            else if (!isNaN(Date.parse(itemVal))) return "Date";
            else if (itemVal.startsWith("http")) return "URL";
            else if (itemVal.match(/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/) != null) return "email";
            else return "string";
        }

        window.addEventListener("message", (event) => {
            let data = event.data;

            if (typeof data != typeof {}) {
                console.log("Not object data");
                return;
            }

            if (!data["jroozy"]) {
                console.log("Not CMS data");
                return;
            }

            if (data.action == "load_CMS") {
                cols = Object.keys(data.items[0])
                //.filter(c => !c.startsWith("_")); // remove internals
                cols.forEach(c => cols_name_map[c] = getReadableColName(c))
                cols.forEach(c => cols_type_map[c] = getColType(data.items[0][c]))
                whitelisted_cols = cols.filter(c => !columns_blacklist.includes(c));

                data_cache = data;
            }
            else if (data.action == "search") {
                search_cache = data;
            }
            else if (data.action == "hide_columns") {
                columns_blacklist.push(...data.columns)
                whitelisted_cols = cols.filter(c => !columns_blacklist.includes(c));
            }
            else if (data.action == "show_columns") {
                columns_blacklist = columns_blacklist.filter(c => !data.columns.includes(c))
                whitelisted_cols = cols.filter(c => !columns_blacklist.includes(c));
            }
            else if (data.action == "page") {
                page_num = parseInt(data.page_num);
                page_size = parseInt(data.page_size);
            } else if (data.action == "sort") {
                sort_order = parseInt(data.sort_order)
                sort_column = data.sort_column;
            }
            redraw();
        })

        function redraw() {
            // header
            document.getElementById("CMS_table").innerHTML = "";
            makeRow(whitelisted_cols.map(c => cols_name_map[c]), true);

            // filter and search
            let filtered_items = data_cache.items.filter(it => {
                let item_data = whitelisted_cols.map(c => it[c])

                return (
                    search_cache == undefined ||
                    search_cache.search_phrase == "" ||
                    item_data.some(d => d && d.toString().includes(search_cache.search_phrase)))
            })
            // sort by column
            if (whitelisted_cols.includes(sort_column)) {
                filtered_items.sort((a, b) => {
                    switch (cols_type_map[sort_column]) {
                        case "number":
                            return sort_order * a[sort_column] - sort_order * b[sort_column];
                            break;
                        case "Date":
                            return sort_order * new Date(a[sort_column]) - sort_order * new Date(b[sort_column]);
                            break;
                        case "URL":
                        case "string":
                            if (a[sort_column] < b[sort_column]) return -sort_order;
                            else if (a[sort_column] > b[sort_column]) return sort_order;
                            else return 0;
                            break;
                        default:
                            return 0;
                            break;
                    }
                })
            }

            // rows
            for (let i = page_num * page_size; i < (page_num + 1) * page_size && i < filtered_items.length; i++) {
                makeRow(whitelisted_cols.map(c => filtered_items[i][c]));
            }
        }
    </script>
</body>

</html>